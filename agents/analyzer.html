#!/usr/bin/env python3
"""
Flask Web Backend for Resume Analyzer
Connects the HTML interface to your resume analysis Python script
"""

from flask import Flask, request, jsonify, render_template_string, send_from_directory
from flask_cors import CORS
import os
import tempfile
from werkzeug.utils import secure_filename
import json
import logging
from pathlib import Path

# Import your existing analyzer (make sure the file is in the same directory)
try:
    from resume_analyzer_enhanced import ResumeAnalyzer
except ImportError:
    print("‚ùå Could not import ResumeAnalyzer. Make sure resume_analyzer_enhanced.py is in the same directory.")
    exit(1)

# Setup Flask app
app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size
app.config['UPLOAD_FOLDER'] = tempfile.gettempdir()
CORS(app)  # Enable CORS for frontend-backend communication

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Allowed file extensions
ALLOWED_EXTENSIONS = {'pdf'}

def allowed_file(filename):
    """Check if file extension is allowed"""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/')
def index():
    """Serve the main HTML interface"""
    html_content = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Resume Analyzer - Get Instant Job Recommendations</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
            }

            .hero {
                text-align: center;
                margin-bottom: 3rem;
                color: white;
            }

            .hero h1 {
                font-size: 3rem;
                margin-bottom: 1rem;
                font-weight: 700;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }

            .hero p {
                font-size: 1.2rem;
                opacity: 0.9;
                margin-bottom: 2rem;
            }

            .features {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .feature {
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                color: white;
            }

            .feature-icon {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }

            .analyzer-card {
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                overflow: hidden;
                margin-top: 2rem;
            }

            .card-header {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 2rem;
                text-align: center;
            }

            .card-header h2 {
                font-size: 1.8rem;
                margin-bottom: 0.5rem;
            }

            .card-content {
                padding: 2rem;
            }

            .upload-section {
                border: 3px dashed #ddd;
                border-radius: 12px;
                padding: 3rem 2rem;
                text-align: center;
                margin-bottom: 2rem;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .upload-section:hover {
                border-color: #4CAF50;
                background: #f9f9f9;
            }

            .upload-section.dragover {
                border-color: #4CAF50;
                background: #e8f5e8;
            }

            .upload-icon {
                font-size: 3rem;
                color: #4CAF50;
                margin-bottom: 1rem;
            }

            .file-input {
                display: none;
            }

            .upload-btn {
                background: #4CAF50;
                color: white;
                border: none;
                padding: 1rem 2rem;
                border-radius: 8px;
                font-size: 1.1rem;
                cursor: pointer;
                transition: background 0.3s ease;
                margin-top: 1rem;
            }

            .upload-btn:hover {
                background: #45a049;
            }

            .text-section {
                margin-top: 2rem;
            }

            .text-area {
                width: 100%;
                min-height: 200px;
                border: 2px solid #ddd;
                border-radius: 8px;
                padding: 1rem;
                font-size: 1rem;
                font-family: 'Courier New', monospace;
                resize: vertical;
            }

            .text-area:focus {
                outline: none;
                border-color: #4CAF50;
            }

            .analyze-btn {
                background: linear-gradient(135deg, #FF6B6B, #FF5252);
                color: white;
                border: none;
                padding: 1.2rem 3rem;
                border-radius: 50px;
                font-size: 1.2rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                width: 100%;
                margin-top: 1.5rem;
                position: relative;
                overflow: hidden;
            }

            .analyze-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(255,107,107,0.3);
            }

            .analyze-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .loading {
                display: none;
                text-align: center;
                padding: 2rem;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #4CAF50;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .results-section {
                display: none;
                margin-top: 2rem;
                background: #f8f9fa;
                border-radius: 12px;
                padding: 2rem;
            }

            .profile-summary {
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .profile-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .profile-item {
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 6px;
                border-left: 4px solid #4CAF50;
            }

            .profile-item strong {
                color: #333;
                display: block;
                margin-bottom: 0.5rem;
            }

            .analysis-content {
                background: white;
                border-radius: 8px;
                padding: 2rem;
                line-height: 1.6;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .error-message {
                background: #fee;
                border: 1px solid #fcc;
                color: #c33;
                padding: 1rem;
                border-radius: 8px;
                margin-top: 1rem;
                display: none;
            }

            .success-message {
                background: #efe;
                border: 1px solid #cfc;
                color: #3c3;
                padding: 1rem;
                border-radius: 8px;
                margin-top: 1rem;
                display: none;
            }

            @media (max-width: 768px) {
                .hero h1 {
                    font-size: 2rem;
                }
                
                .container {
                    padding: 1rem;
                }
                
                .card-content {
                    padding: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="hero">
                <h1>üéØ AI Resume Analyzer</h1>
                <p>Get instant job recommendations and market insights powered by advanced AI</p>
                
                <div class="features">
                    <div class="feature">
                        <div class="feature-icon">üß†</div>
                        <h3>AI-Powered Analysis</h3>
                        <p>Advanced AI extracts your profile and recommends perfect-fit jobs</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">üí∞</div>
                        <h3>Real Salary Data</h3>
                        <p>Get market-accurate salary ranges based on your experience</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">üìä</div>
                        <h3>Market Insights</h3>
                        <p>Comprehensive analysis of your competitiveness in the job market</p>
                    </div>
                </div>
            </div>

            <div class="analyzer-card">
                <div class="card-header">
                    <h2>Upload Your Resume</h2>
                    <p>PDF files or paste your resume text below</p>
                </div>
                
                <div class="card-content">
                    <div class="upload-section" onclick="document.getElementById('file-input').click()">
                        <div class="upload-icon">üìÑ</div>
                        <h3>Drop your PDF resume here</h3>
                        <p>or click to browse files</p>
                        <input type="file" id="file-input" class="file-input" accept=".pdf" />
                        <button class="upload-btn" type="button">Choose File</button>
                    </div>

                    <div class="text-section">
                        <h3 style="margin-bottom: 1rem;">Or paste your resume text:</h3>
                        <textarea id="resume-text" class="text-area" placeholder="Paste your resume text here...

Example:
John Smith
Software Engineer

EXPERIENCE
Senior Software Developer | ABC Tech | 2020-2024
‚Ä¢ Developed scalable web applications using React and Node.js
‚Ä¢ Led a team of 5 developers on multiple projects
‚Ä¢ Improved system performance by 40%

SKILLS
JavaScript, Python, React, AWS, Docker, SQL

EDUCATION
Bachelor of Science in Computer Science | XYZ University | 2018"></textarea>
                    </div>

                    <button id="analyze-btn" class="analyze-btn" onclick="analyzeResume()">
                        üöÄ Analyze My Resume
                    </button>

                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <h3>Analyzing your resume...</h3>
                        <p>AI is extracting your profile and finding perfect job matches</p>
                    </div>

                    <div id="error-message" class="error-message"></div>
                    <div id="success-message" class="success-message"></div>

                    <div id="results" class="results-section">
                        <h2>üìä Your AI-Powered Career Analysis</h2>
                        
                        <div class="profile-summary">
                            <h3>ü§ñ AI-Extracted Profile</h3>
                            <div id="profile-content" class="profile-grid">
                                <!-- Profile items will be inserted here -->
                            </div>
                        </div>

                        <div class="analysis-content">
                            <h3>üìù Detailed Analysis & Recommendations</h3>
                            <div id="analysis-text">
                                <!-- Analysis content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let selectedFile = null;

            // File upload handling
            const fileInput = document.getElementById('file-input');
            const uploadSection = document.querySelector('.upload-section');

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    uploadSection.innerHTML = `
                        <div class="upload-icon">‚úÖ</div>
                        <h3>${file.name}</h3>
                        <p>Ready to analyze</p>
                        <button class="upload-btn" onclick="document.getElementById('file-input').click()">Change File</button>
                    `;
                    showSuccess(`File "${file.name}" uploaded successfully!`);
                }
            });

            // Drag and drop functionality
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    selectedFile = files[0];
                    fileInput.files = files;
                    uploadSection.innerHTML = `
                        <div class="upload-icon">‚úÖ</div>
                        <h3>${files[0].name}</h3>
                        <p>Ready to analyze</p>
                        <button class="upload-btn" onclick="document.getElementById('file-input').click()">Change File</button>
                    `;
                    showSuccess(`File "${files[0].name}" uploaded successfully!`);
                } else {
                    showError('Please upload a PDF file.');
                }
            });

            // Main analysis function
            async function analyzeResume() {
                const resumeText = document.getElementById('resume-text').value.trim();
                
                // Validation
                if (!selectedFile && !resumeText) {
                    showError('Please upload a PDF file or paste your resume text.');
                    return;
                }

                // Show loading state
                showLoading(true);
                hideMessages();

                try {
                    let analysisData;

                    if (selectedFile) {
                        analysisData = await analyzeWithPDF(selectedFile);
                    } else {
                        analysisData = await analyzeWithText(resumeText);
                    }

                    displayResults(analysisData);
                    showSuccess('Analysis completed successfully!');

                } catch (error) {
                    console.error('Analysis error:', error);
                    showError(`Analysis failed: ${error.message}`);
                } finally {
                    showLoading(false);
                }
            }

            // Real Flask backend API calls
            async function analyzeWithText(resumeText) {
                const response = await fetch('/analyze-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ resume_text: resumeText })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Analysis failed');
                }
                
                return await response.json();
            }

            async function analyzeWithPDF(file) {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/analyze-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'PDF analysis failed');
                }
                
                return await response.json();
            }

            // Display results
            function displayResults(data) {
                const resultsSection = document.getElementById('results');
                const profileContent = document.getElementById('profile-content');
                const analysisText = document.getElementById('analysis-text');

                if (data.success) {
                    const profile = data.extracted_profile;
                    
                    // Display profile
                    profileContent.innerHTML = `
                        <div class="profile-item">
                            <strong>Experience Level</strong>
                            ${profile.experience_level ? profile.experience_level.charAt(0).toUpperCase() + profile.experience_level.slice(1) : 'N/A'}
                        </div>
                        <div class="profile-item">
                            <strong>Years of Experience</strong>
                            ${profile.years_of_experience || 'N/A'}
                        </div>
                        <div class="profile-item">
                            <strong>Target Roles</strong>
                            ${profile.target_roles ? profile.target_roles.join(', ') : 'N/A'}
                        </div>
                        <div class="profile-item">
                            <strong>Key Skills</strong>
                            ${profile.key_skills ? profile.key_skills.join(', ') : 'N/A'}
                        </div>
                        <div class="profile-item">
                            <strong>Estimated Salary</strong>
                            ${profile.estimated_salary_range || 'N/A'}
                        </div>
                        <div class="profile-item">
                            <strong>Work Preference</strong>
                            ${profile.work_arrangement_preference || 'N/A'}
                        </div>
                    `;

                    // Display analysis
                    if (data.groq_analysis && data.groq_analysis.success) {
                        const formattedAnalysis = formatAnalysisText(data.groq_analysis.analysis);
                        analysisText.innerHTML = formattedAnalysis;
                    } else {
                        analysisText.innerHTML = '<p>Analysis not available. Please try again.</p>';
                    }

                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            }

            function formatAnalysisText(text) {
                if (!text) return '<p>No analysis available.</p>';
                
                return text
                    .replace(/## (.*)/g, '<h3 style="color: #4CAF50; margin: 1.5rem 0 1rem 0;">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/‚Ä¢ (.*)/g, '<li style="margin: 0.5rem 0;">$1</li>')
                    .replace(/(\n\n)/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }

            // UI helper functions
            function showLoading(show) {
                const loading = document.getElementById('loading');
                const analyzeBtn = document.getElementById('analyze-btn');
                
                if (show) {
                    loading.style.display = 'block';
                    analyzeBtn.disabled = true;
                    analyzeBtn.textContent = 'Analyzing...';
                } else {
                    loading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'üöÄ Analyze My Resume';
                }
            }

            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 8000);
            }

            function showSuccess(message) {
                const successDiv = document.getElementById('success-message');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => successDiv.style.display = 'none', 3000);
            }

            function hideMessages() {
                document.getElementById('error-message').style.display = 'none';
                document.getElementById('success-message').style.display = 'none';
            }
        </script>
    </body>
    </html>
    """
    return html_content

@app.route('/analyze-text', methods=['POST'])
def analyze_text():
    """Analyze resume from text input"""
    try:
        data = request.get_json()
        
        if not data or 'resume_text' not in data:
            return jsonify({
                'success': False,
                'error': 'No resume text provided'
            }), 400
        
        resume_text = data['resume_text']
        
        if len(resume_text.strip()) < 50:
            return jsonify({
                'success': False,
                'error': 'Resume text too short for meaningful analysis'
            }), 400
        
        # Initialize analyzer
        analyzer = ResumeAnalyzer()
        
        # Run analysis
        result = analyzer.analyze_resume_from_text(resume_text)
        
        logger.info(f"Text analysis completed: {result['success']}")
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"Text analysis error: {e}")
        return jsonify({
            'success': False,
            'error': f'Analysis failed: {str(e)}'
        }), 500

@app.route('/analyze-pdf', methods=['POST'])
def analyze_pdf():
    """Analyze resume from PDF file"""
    try:
        # Check if file was uploaded
        if 'file' not in request.files:
            return jsonify({
                'success': False,
                'error': 'No file uploaded'
            }), 400
        
        file = request.files['file']
        
        if file.filename == '':
            return jsonify({
                'success': False,
                'error': 'No file selected'
            }), 400
        
        if not allowed_file(file.filename):
            return jsonify({
                'success': False,
                'error': 'Only PDF files are allowed'
            }), 400
        
        # Save uploaded file temporarily
        filename = secure_filename(file.filename)
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(filepath)
        
        try:
            # Initialize analyzer
            analyzer = ResumeAnalyzer()
            
            # Run analysis
            result = analyzer.analyze_resume_from_pdf(filepath)
            
            logger.info(f"PDF analysis completed: {result['success']}")
            return jsonify(result)
            
        finally:
            # Clean up temporary file
            try:
                os.remove(filepath)
            except:
                pass
        
    except Exception as e:
        logger.error(f"PDF analysis error: {e}")
        return jsonify({
            'success': False,
            'error': f'Analysis failed: {str(e)}'
        }), 500

@app.route('/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    try:
        # Test if Groq API key is available
        groq_key = os.getenv('GROQ_API_KEY')
        
        return jsonify({
            'status': 'healthy',
            'groq_api_configured': bool(groq_key),
            'message': 'Resume Analyzer API is running'
        })
    except Exception as e:
        return jsonify({
            'status': 'unhealthy',
            'error': str(e)
        }), 500

@app.route('/api/info', methods=['GET'])
def api_info():
    """Get API information"""
    return jsonify({
        'name': 'Resume Analyzer API',
        'version': '1.0.0',
        'endpoints': {
            '/': 'Main web interface',
            '/analyze-text': 'POST - Analyze resume from text',
            '/analyze-pdf': 'POST - Analyze resume from PDF file',
            '/health': 'GET - Health check',
            '/api/info': 'GET - API information'
        },
        'supported_formats': ['PDF', 'Text'],
        'max_file_size': '16MB'
    })

@app.errorhandler(413)
def too_large(e):
    """Handle file too large error"""
    return jsonify({
        'success': False,
        'error': 'File too large. Maximum size is 16MB.'
    }), 413

@app.errorhandler(404)
def not_found(e):
    """Handle 404 errors"""
    return jsonify({
        'success': False,
        'error': 'Endpoint not found'
    }), 404

@app.errorhandler(500)
def internal_error(e):
    """Handle internal server errors"""
    return jsonify({
        'success': False,
        'error': 'Internal server error'
    }), 500

if __name__ == '__main__':
    # Check environment setup
    groq_key = os.getenv('GROQ_API_KEY')
    if not groq_key:
        print("‚ö†Ô∏è  WARNING: GROQ_API_KEY not found in environment variables")
        print("   The analyzer may not work properly without it.")
        print("   Create a .env file with: GROQ_API_KEY=your_groq_api_key_here")
    else:
        print("‚úÖ GROQ_API_KEY found")
    
    print("\nüöÄ Starting Resume Analyzer Web Server")
    print("=" * 50)
    print("üìç Local URL: http://127.0.0.1:5000")
    print("üìç Network URL: http://0.0.0.0:5000")
    print("\nüîß Available Endpoints:")
    print("   GET  /          - Web interface")
    print("   POST /analyze-text - Analyze text resume")
    print("   POST /analyze-pdf  - Analyze PDF resume")
    print("   GET  /health    - Health check")
    print("   GET  /api/info  - API information")
    print("\nüí° Press Ctrl+C to stop the server")
    print("=" * 50)
    
    # Run the Flask development server
    app.run(
        host='0.0.0.0',  # Allow external connections
        port=5000,       # Default Flask port
        debug=True,      # Enable debug mode for development
        threaded=True    # Handle multiple requests concurrently
    )